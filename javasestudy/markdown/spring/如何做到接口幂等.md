# 如何做到接口幂等

### 什么是幂等
幂等是指一个接口访问一次或者多次，产生的影响是一样的，不需要担心重复执行对系统的影响。

### 幂等场景

1. 查询
    查询操作天然幂等
2. 删除操作
    删除一次和删除多次的操作产生的结果是一样的，也是幂等
3. 更新操作
    更新有两种情况：更新为固定值和在原有值上修改
    - 更新固定值：幂等
    - 修改原有值：非幂等
4. 新增操作
    非幂等
    
 所以，修改原有值和新增是我们主要关注幂等的操作。
 
### 解决方案
#### 全局唯一ID
可以与业务端约定，根据操作和内容生成一个全局ID。后端在操作时先判断这个ID
是否存在，存在则证明已有操作，不执行，否则将这个ID保存在redis等存储系统中，
再进行后续操作。

这个方法看起来十分简单，但是问题在于如果操作写入缓存之后服务挂了，那么后续的操作
会被认为已被执行而拒绝。所以这个ID的存储要保证一个过期时间。

#### 去重表
对于更新的操作，有些业务场景是对一个标识只能进行一次操作（比如订单的支付），
那么我们设置一张去重表，以这个标识（订单ID）为唯一建，如果订单已被操作，那么就会
抛出异常，业务回滚。
？？并发读相同的内容怎么办

#### 乐观锁&悲观锁
获取数据时用悲观锁来获取，降低了系统吞吐量，慎用。

乐观锁是采用类似于版本号的概念来保证，如果当前版本号高于预期，那么就不再进行操作

#### 项目实践
关于借款、还款等敏感操作，使用的是类token的操作，即uid+操作key，保证
用户的这次操作可以只执行一次。


